# Version: 0.0.2
box: node

build:
    steps:
        - script:
            name: git-crypt
            code: |
                wget $GIT_CRYPT_LINK/$GIT_CRYPT_ARCHIVE -P /pipeline/git-crypt
                cd /pipeline/git-crypt; tar -zxvf &GIT_CRYPT_ARCHIVE; cd git-crypt; sudo make; sudo make install PREFIX=/usr/local/bin/;
                git crypt status
    # A step that executes `npm install` command
        - npm-install
        - script:
            name: run build
            code: npm run build

        - script:
            name: echo nodejs information
            code: |
                echo "node version $(node -v) running"
                echo "npm version $(npm -v) running"

    after-steps:
        - slack-notifier:
            url: $SLACK_URL
            channel: notifications
            username: Wercker Event Notifier
            # notify_on: "failed"

deploy:
    steps:
        - wercker/add-ssh-key:
            keyname: SSH_KEY
        - add-to-known_hosts:
            hostname: $REMOTE_HOST
        - script:
            name: Copy dist directory
            code: |
                tar -czvf dist.tar.gz ./dist
                ssh $LOGIN@$REMOTE_HOST "cd ~/orlp-web/ && rm -rf dist*"
                scp dist.tar.gz $LOGIN@$REMOTE_HOST:~/orlp-web/dist.tar.gz
                ssh $LOGIN@$REMOTE_HOST "cd ~/orlp-web/ && tar -zxvf dist.tar.gz"
        - script:
            name: Stop Docker container
            code: |
                scp check_if_web_run.sh $LOGIN@$REMOTE_HOST:~/orlp-web/
                ssh $LOGIN@$REMOTE_HOST "sh check_if_web_run.sh"
        - script:
            name: Run Docker container
            code: |
                ssh $LOGIN@$REMOTE_HOST "docker create --name orlp-web --net=orlp --restart=always -e 'LETSENCRYPT_EMAIL=$LETSENCRYPT_EMAIL' -e 'LETSENCRYPT_HOST=$REMOTE_HOST' -e 'VIRTUAL_HOST=$REMOTE_HOST' nginx && cd ~/orlp-web/ && docker cp default.conf orlp-web:/etc/nginx/conf.d/ && docker cp nginx.conf orlp-web:/etc/nginx/ && docker cp dist/. orlp-web:/usr/share/nginx/html/&& docker start orlp-web"

    after-steps:
        - install-packages:
            packages: ruby
        - wantedly/pretty-slack-notify:
            webhook_url: $SLACK_URL
            channel: notifications
            username: Wercker Event Notifier
            # notify_on: "failed"
